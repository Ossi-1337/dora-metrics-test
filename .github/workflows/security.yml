name: Security gates

on:
  workflow_run:
    workflows: ["CI"]  
    types: ["completed"]
    branches: [ main ]

permissions:
  contents: read          
  actions: read         
  security-events: write

jobs:
  # Check if CI succeeded
  check_ci_status:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run'
    steps:
      - name: Check CI workflow result
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "CI workflow failed, stopping security scans"
            exit 1
          fi
  
  detect_changed_services:
    name: Detect changed services
    runs-on: ubuntu-latest
    outputs:
      shared: ${{ steps.filter.outputs.shared }}
      customer: ${{ steps.filter.outputs.customer }}
      order: ${{ steps.filter.outputs.order }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            shared:
              - 'src/Shared/**'
              - 'Directory.Build.props'
              - 'global.json'
              - '*.sln'
              - '.github/workflows/**'

            customer:
              - 'src/Customer/**'
              - 'tests/Customer.Tests/**'

            order:
              - 'src/OrderAndDelivery/**'
              - 'tests/OrderAndDelivery.Tests/**'

  codeql:
    name: CodeQL – repo-wide analysis
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.customer == 'true' || needs.detect_changed_services.outputs.order == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: csharp
          build-mode: manual

      - name: Build for CodeQL
        run: |
          if [[ "${{ needs.detect_changed_services.outputs.customer }}" == "true" || "${{ needs.detect_changed_services.outputs.shared }}" == "true" ]]; then
            echo "Building Customer service for CodeQL"
            
            dotnet restore src/Customer/Customer.Api.csproj
            dotnet build src/Customer/Customer.Api.csproj -c Release --no-restore
          fi

          if [[ "${{ needs.detect_changed_services.outputs.order }}" == "true" || "${{ needs.detect_changed_services.outputs.shared }}" == "true" ]]; then
            echo "Building Order & Delivery service for CodeQL"

            dotnet restore src/OrderAndDelivery/OrderAndDelivery.Api.csproj
            dotnet build src/OrderAndDelivery/OrderAndDelivery.Api.csproj -c Release --no-restore
          fi

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  security_customer:
    name: Customer – security gates
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.customer == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Install gitleaks
        run: |
          VERSION=8.18.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
          | tar xz -C /usr/local/bin gitleaks

      - name: Gitleaks scan (Customer)
        run: |
          gitleaks detect \
            --source . \
            --config .gitleaks.toml \
            -v

      - name: Trivy FS scan (Customer, HIGH/CRITICAL fail)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scan-ref: src/Customer
          format: sarif
          output: trivy-customer-fs.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL

      - name: Trivy image scan (Customer, HIGH/CRITICAL fail)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: image
          image-ref: ghcr.io/${{ github.repository_owner }}/mtogo-customer:${{ github.event.workflow_run.head_sha }}
          format: sarif
          output: trivy-customer-image.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL

      - uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-customer-fs.sarif
        continue-on-error: true

      - uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-customer-image.sarif
        continue-on-error: true

  security_order:
    name: Order & Delivery – security gates
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.order == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Install gitleaks
        run: |
          VERSION=8.18.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
          | tar xz -C /usr/local/bin gitleaks

      - name: Gitleaks scan (Order & Delivery)
        run: |
          gitleaks detect \
            --source . \
            --config .gitleaks.toml \
            -v

      - name: Trivy FS scan (Order & Delivery, HIGH/CRITICAL fail)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scan-ref: src/OrderAndDelivery
          format: sarif
          output: trivy-order-fs.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL

      - name: Trivy image scan (Order & Delivery, HIGH/CRITICAL fail)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: image
          image-ref: ghcr.io/${{ github.repository_owner }}/mtogo-order-and-delivery:${{ github.event.workflow_run.head_sha }}
          format: sarif
          output: trivy-order-image.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL

      - uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-order-fs.sarif
        continue-on-error: true

      - uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-order-image.sarif
        continue-on-error: true
