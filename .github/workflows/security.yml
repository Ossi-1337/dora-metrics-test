name: Security gates

on:
  workflow_run:
    workflows: ["CI"]
    types: ["completed"]
    branches: [ main ]

permissions:
  contents: read
  actions: read
  security-events: write
  packages: read

jobs:
  # Check if CI succeeded
  check_ci_status:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run'
    steps:
      - name: Check CI workflow result
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "CI workflow failed, stopping security scans"
            exit 1
          fi

  detect_changed_services:
    name: Detect changed services
    runs-on: ubuntu-latest
    outputs:
      shared: ${{ steps.filter.outputs.shared }}
      customer: ${{ steps.filter.outputs.customer }}
      order: ${{ steps.filter.outputs.order }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            shared:
              - 'src/Shared/**'
              - 'Directory.Build.props'
              - 'global.json'
              - '*.sln'
              - '.github/workflows/**'

            customer:
              - 'src/Customer/**'
              - 'tests/Customer.Tests/**'

            order:
              - 'src/OrderAndDelivery/**'
              - 'tests/OrderAndDelivery.Tests/**'

  codeql:
    name: CodeQL – repo-wide analysis
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.customer == 'true' || needs.detect_changed_services.outputs.order == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: csharp
          build-mode: manual

      - name: Build for CodeQL
        run: |
          if [[ "${{ needs.detect_changed_services.outputs.customer }}" == "true" || "${{ needs.detect_changed_services.outputs.shared }}" == "true" ]]; then
            echo "Building Customer service for CodeQL"

            dotnet restore src/Customer/Customer.Api.csproj
            dotnet build src/Customer/Customer.Api.csproj -c Release --no-restore
          fi

          if [[ "${{ needs.detect_changed_services.outputs.order }}" == "true" || "${{ needs.detect_changed_services.outputs.shared }}" == "true" ]]; then
            echo "Building Order & Delivery service for CodeQL"

            dotnet restore src/OrderAndDelivery/OrderAndDelivery.Api.csproj
            dotnet build src/OrderAndDelivery/OrderAndDelivery.Api.csproj -c Release --no-restore
          fi

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  security_customer:
    name: Customer – security gates
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.customer == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Set lowercase owner
        run: echo "OWNER_LC=${OWNER,,}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Customer image from GHCR
        run: docker pull ghcr.io/${{ env.OWNER_LC }}/mtogo-customer:${{ github.event.workflow_run.head_sha }}

      - name: Install gitleaks
        run: |
          VERSION=8.18.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
          | tar xz -C /usr/local/bin gitleaks

      - name: Gitleaks scan (Customer)
        run: |
          gitleaks detect \
            --source . \
            --config .gitleaks.toml \
            -v

      - name: Trivy FS scan (Customer, HIGH/CRITICAL fail)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scan-ref: src/Customer
          format: sarif
          output: trivy-customer-fs.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL

      - name: Trivy image scan (Customer, HIGH/CRITICAL fail)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: image
          image-ref: ghcr.io/${{ env.OWNER_LC }}/mtogo-customer:${{ github.event.workflow_run.head_sha }}
          format: sarif
          output: trivy-customer-image.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL

      - name: Upload Trivy FS SARIF (Customer)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-customer-fs.sarif
          category: trivy-customer-fs

      - name: Upload Trivy image SARIF (Customer)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-customer-image.sarif
          category: trivy-customer-image

  security_order:
    name: Order & Delivery – security gates
    needs: detect_changed_services
    if: ${{ needs.detect_changed_services.outputs.order == 'true' || needs.detect_changed_services.outputs.shared == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Set lowercase owner
        run: echo "OWNER_LC=${OWNER,,}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Order & Delivery image from GHCR
        run: docker pull ghcr.io/${{ env.OWNER_LC }}/mtogo-order-and-delivery:${{ github.event.workflow_run.head_sha }}

      - name: Install gitleaks
        run: |
          VERSION=8.18.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz \
          | tar xz -C /usr/local/bin gitleaks

      - name: Gitleaks scan (Order & Delivery)
        run: |
          gitleaks detect \
            --source . \
            --config .gitleaks.toml \
            -v

      - name: Trivy FS scan (Order & Delivery, HIGH/CRITICAL fail)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scan-ref: src/OrderAndDelivery
          format: sarif
          output: trivy-order-fs.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL

      - name: Trivy image scan (Order & Delivery, HIGH/CRITICAL fail)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: image
          image-ref: ghcr.io/${{ env.OWNER_LC }}/mtogo-order-and-delivery:${{ github.event.workflow_run.head_sha }}
          format: sarif
          output: trivy-order-image.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
      
      - name: Upload Trivy FS SARIF (Order & Delivery)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-order-fs.sarif
          category: trivy-order-fs

      - name: Upload Trivy image SARIF (Order & Delivery)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-order-image.sarif
          category: trivy-order-image

  security_all_checks:
    name: Security – all checks
    runs-on: ubuntu-latest
    needs:
      - check_ci_status
      - detect_changed_services
      - codeql
      - security_customer
      - security_order
    # Always run so we can explicitly fail even if others failed
    if: always()

    steps:
      - name: Evaluate security job results
        run: |
          echo "check_ci_status:        ${{ needs.check_ci_status.result }}"
          echo "detect_changed_services: ${{ needs.detect_changed_services.result }}"
          echo "codeql:                 ${{ needs.codeql.result }}"
          echo "security_customer:      ${{ needs.security_customer.result }}"
          echo "security_order:         ${{ needs.security_order.result }}"

          failed=false

          for result in \
            "${{ needs.check_ci_status.result }}" \
            "${{ needs.codeql.result }}" \
            "${{ needs.security_customer.result }}" \
            "${{ needs.security_order.result }}"; do

            if [ "$result" = "failure" ] || [ "$result" = "cancelled" ]; then
              failed=true
            fi
          done

          if [ "$failed" = true ]; then
            echo "One or more security jobs failed or were cancelled."
            exit 1
          fi

          echo "All required security jobs succeeded (or were skipped)."
